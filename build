#!/usr/bin/env runghc
import Development.Shake
import Development.Shake.Command
import Development.Shake.FilePath
import Development.Shake.Util

main :: IO ()
main = shakeArgs shakeOptions { shakeFiles = ".build/" } $ do
  want [ "install" ]

  "install" ~> do
    putNormal "** installing dotfiles"
    cmd "bash -c " [ "cp .bash.sh ~/" ++ " && cp .tmux.conf ~/"
      ++ " && cp .vimrc ~/" ++ " && cp .psqlrc ~/" ++ " && cp .gnuplot ~/"
      ++ " && mkdir -p ~/.emacs.d && cp em ~/.emacs.d && chmod 755 ~/.emacs.d/em"
      ++ " && mkdir -p ~/.emacs.d && cp emacs.el ~/.emacs.d" ]

  "update" ~> do
    putNormal "** updating repos"
    cmd "bash -c " [ "function updateRepo { echo [ $1 ]; cd ~/.emacs.d"
      ++ "; if cd $1; then ${3:-git} pull; else ${3:-git} clone $2; fi }"
      ++ "; updateRepo 'zenburn-emacs' 'https://github.com/bbatsov/zenburn-emacs.git'"
      ++ " && updateRepo 'js2-mode' 'https://github.com/mooz/js2-mode.git'"
      ++ " && cd ~/.emacs.d/js2-mode && make"
      ++ " && updateRepo 'haskell-mode' 'https://github.com/haskell/haskell-mode.git'"
      -- ++ " && cd ~/.emacs.d/haskell-mode && EMACS=/usr/local/bin/emacs make"
      ++ " && updateRepo 'org-mode' 'https://orgmode.org/org-mode.git'"
      ++ " && cd ~/.emacs.d/org-mode && make autoloads"
      ++ " && updateRepo 'jade-mode' 'https://github.com/brianc/jade-mode.git'"
      ++ " && updateRepo 'markdown-mode' 'https://github.com/defunkt/markdown-mode.git'"
      ++ " && updateRepo 'gnuplot-mode' 'https://github.com/mkmcc/gnuplot-mode.git'"
      ++ " && updateRepo 'dash' 'https://github.com/magnars/dash.el.git dash'"
      ++ " && updateRepo 'magit' 'https://github.com/magit/magit.git'"
      ++ " && cd ~/.emacs.d/magit && make"
      ++ " && updateRepo 'evil' 'https://bitbucket.org/lyro/evil' 'hg'"
      ++ " && cd ~/.emacs.d/evil && make" ]

  "clean" ~> do
    putNormal "** removing dotfiles"
    cmd "bash -c " [ "rm ~/.bash.sh ~/.tmux.conf ~/.vimrc ~/.psqlrc ~/.gnuplot"
      ++ " ~/.emacs.d/em ~/.emacs.d/emacs.el" ]
